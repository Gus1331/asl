<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="js/sessao.js"></script>
    <link rel="stylesheet" href="style/dashboard.css">
    <link rel="shortcut icon" href="assets/content/logo.png" type="image/x-icon">
</head>

<body onload="validarSessao(), obterDadosDiario()">
    <div class="containerFull">
        <main>
            <div class="sidebar">

                <div class="topSidebar">
                    <div class="icon">
                        <img src="https://cdn-icons-png.flaticon.com/512/5087/5087579.png">
                    </div>
                    <h2 id="b_usuario">User123</h2>
                    <div class="userOptions">
                        <img src="assets/content/useroptions-icon.png">
                    </div>
                </div>

                <div class="midSidebar">
                    <div class="listTitle">
                        <h1>Dashboards</h1>
                        <div class="icon">
                            <img src="assets/content/dashbord-icon.png">
                        </div>
                    </div>
                    <ul>
                        <a href="producao.html" rel="prev">
                            <li>
                                Produção
                                <div class="icon">
                                    <img src="assets/content/producao-icon.png">
                                </div>
                            </li>
                        </a>
                        <div class="listLines">
                            <div class="line"></div>
                            <div class="line"></div>
                        </div>
                        <a href="" rel="prev">
                            <li class="selected">
                                Renda
                                <div class="icon">
                                    <img src="assets/content/renda-icon.png">
                                </div>
                            </li>
                        </a>
                        <div class="listLines">
                            <div class="line"></div>
                            <div class="line"></div>
                        </div>

                        <a href="geral.html" rel="next">
                            <li>
                                Geral
                                <div class="icon">
                                    <img src="assets/content/geral-icon.png">
                                </div>
                            </li>
                        </a>

                        <div class="listLines">
                            <div class="line"></div>
                            <div class="line"></div>
                            <a href="configuracoes.html" rel="next">
                        </div>
                        <li>
                            Configurações
                            <div class="icon">
                                <img src="assets/content/config-icon.png">
                            </div>
                        </li>
                        </a>
                    </ul>
                </div>

                <div class="bottomSidebar">
                    <div class="logo icon">
                        <img src="assets/content/logo.png">
                    </div>
                    <p class="version">Versão 1.00</p>
                </div>

            </div>
            <div class="dashboard2">

                <!-- CHARTS ------------------------------------------------------------------------ -->
                <div class="dashboardTop3">
                    <div class="chart07">
                        <canvas id="canvas_chart07"></canvas>
                        Janeiro
                    </div>
                    <div class="chart08">
                        <canvas id="canvas_chart08"></canvas>
                        Fevereiro
                    </div>
                    <div class="chart09">
                        <canvas id="canvas_chart09"></canvas>
                        Março
                    </div>
                </div>
                <div class="dashboardMid3">
                    <div class="chart10">
                        <h3>Renda diária de Produtos</h3>
                        <canvas id="canvas_chart10"></canvas>
                    </div>
                    <div class="dashDescription">
                        <h3>Total: 10.9M</h3>
                        <table>
                            <tr>
                                <th>Mês</th>
                                <th>Renda</th>
                            </tr>
                            <tr>
                                <td>Janeiro</td>
                                <td>900 000 R$</td>
                            </tr>
                            <tr>
                                <td>Fevereiro</td>
                                <td class="ngtv">560 000 R$</td>
                            </tr>
                            <tr>
                                <td>Março</td>
                                <td>920 000 R$</td>
                            </tr>
                            <tr>
                                <td>Abril</td>
                                <td>760 000 R$</td>
                            </tr>
                            <tr>
                                <td>Maio</td>
                                <td>910 000 R$</td>
                            </tr>
                            <tr>
                                <td>Junho</td>
                                <td class="ngtv">590 000 R$</td>
                            </tr>
                            <tr>
                                <td>Julho</td>
                                <td>860 000 R$</td>
                            </tr>
                            <tr>
                                <td>Agosto</td>
                                <td>900 000 R$</td>
                            </tr>
                            <tr>
                                <td>Setembro</td>
                                <td>780 000 R$</td>
                            </tr>
                            <tr>
                                <td>Outubro</td>
                                <td>870 000 R$</td>
                            </tr>
                            <tr>
                                <td>Novembro</td>
                                <td>830 000 R$</td>
                            </tr>
                            <tr>
                                <td>Dezembro</td>
                                <td>990 000 R$</td>
                            </tr>

                        </table>
                    </div>
                </div>
                <!-- CHARTS ------------------------------------------------------------------------ -->

            </div>
        </main>
        <div class="gradient"></div>

    </div>
</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    const ctx07 = document.getElementById('canvas_chart07');

    new Chart(ctx07, {
        type: 'bar',
        data: {
            labels: ['Semana 1', 'Semana 2', 'Semana 3', 'Semana 4'],
            datasets: [{
                label: 'Renda',
                data: [20000000, 25000000, 19000000, 20000000, 17000000, 19000000, 25000000, 29000000, 27000000, 28000000, 25000000, 29000000],
                borderWidth: 1,
                backgroundColor: '#0593A2',
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: false,
                }
            }
        }
    });
    const ctx08 = document.getElementById('canvas_chart08');

    new Chart(ctx08, {
        type: 'bar',
        data: {
            labels: ['Semana 1', 'Semana 2', 'Semana 3', 'Semana 4'],
            datasets: [{
                label: 'Renda',
                data: [20000000, 25000000, 19000000, 20000000, 17000000, 19000000, 25000000, 29000000, 27000000, 28000000, 25000000, 29000000],
                borderWidth: 1,
                backgroundColor: '#4177A6',
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: false,
                }
            }
        }
    });
    const ctx09 = document.getElementById('canvas_chart09');

    new Chart(ctx09, {
        type: 'bar',
        data: {
            labels: ['Semana 1', 'Semana 2', 'Semana 3', 'Semana 4'],
            datasets: [{
                label: 'Renda',
                data: [20000000, 25000000, 19000000, 20000000, 17000000, 19000000, 25000000, 29000000, 27000000, 28000000, 25000000, 29000000],
                borderWidth: 1,
                backgroundColor: '#103778',
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: false,
                    min: 10000,
                    ticks: {
                        stepSize: 500
                    }
                }
            }
        }
    });

    // GRAFICO DO DIA
    function obterDadosDiario() {

        fetch(`/medidas/diario`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGrafico(resposta);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
    function plotarGrafico(resposta) {

        console.log('iniciando plotagem do gráfico...', resposta);

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: ['Garrafa', 'Copo', 'Frasco'],
            datasets: [{
                label:[],
                data: [],
                borderWidth: 1,
            }]
        };

        var registro = resposta[0];

        dados.datasets[0].data.push(registro.garrafa * 5);
        dados.datasets[0].data.push(registro.copo * 3);
        dados.datasets[0].data.push(registro.frasco);
        dados.datasets[0].label.push(registro.dia);

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'bar',
            data: dados,
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`canvas_chart10`),
            config
        );
        setTimeout(() => atualizarGrafico(dados, myChart), 30000);
    }

    function atualizarGrafico(dados, myChart) {

        fetch(`/medidas/diario`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {

                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);

                    let avisoCaptura = document.getElementById(`canvas_chart10`)
                    avisoCaptura.innerHTML = ""

                    var registro = resposta[0];

                    dados.datasets[0].data.shift();
                    dados.datasets[0].data.shift();
                    dados.datasets[0].data.shift();
                    dados.datasets[0].label.shift();

                    dados.datasets[0].data.push(registro.garrafa);
                    dados.datasets[0].data.push(registro.copo);
                    dados.datasets[0].data.push(registro.frasco);
                    dados.datasets[0].label.push(registro.dia);

                    myChart.update();

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(dados, myChart), 30000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGrafico(dados, myChart), 30000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }
</script>